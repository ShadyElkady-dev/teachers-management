import React, { useState, useRef, useEffect } from 'react';
import { useAuth } from '../../context/AuthContext';
import Modal from './Modal';
import { formatDateTime } from '../../utils/helpers';
import { FiCamera, FiUser, FiTrash2 } from 'react-icons/fi';
import toast from 'react-hot-toast';
import { doc, updateDoc, getDoc } from 'firebase/firestore';
import { db } from '../../services/firebase';

const UserProfile = () => {
  const { user, logout, updateUserProfile, USER_ROLES } = useAuth();
  const [showProfileModal, setShowProfileModal] = useState(false);
  const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
  const [profileImage, setProfileImage] = useState(null);
  const [isEditingImage, setIsEditingImage] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const fileInputRef = useRef(null);

  // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ© ŸÖŸÜ Firestore ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÉŸàŸÜ
  useEffect(() => {
    const loadUserAvatar = async () => {
      if (user?.id) {
        try {
          // ÿ£ŸàŸÑÿßŸã ŸÜÿ≠ÿßŸàŸÑ ÿ¨ŸÑÿ® ÿßŸÑÿµŸàÿ±ÿ© ŸÖŸÜ Firestore
          const userDoc = await getDoc(doc(db, 'users', user.id));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            if (userData.avatar) {
              setProfileImage(userData.avatar);
              // ÿ≠ŸÅÿ∏ ŸÜÿ≥ÿÆÿ© ŸÅŸä localStorage ŸÉŸÄ cache
              localStorage.setItem(`userAvatar_${user.id}`, userData.avatar);
            }
          } else {
            // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ŸÅŸä Firestoreÿå ŸÜÿ¨ÿ±ÿ® localStorage
            const savedImage = localStorage.getItem(`userAvatar_${user.id}`);
            if (savedImage) {
              setProfileImage(savedImage);
              // ÿ±ŸÅÿπŸáÿß ÿ•ŸÑŸâ Firestore
              await saveAvatarToFirestore(savedImage);
            }
          }
        } catch (error) {
          console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ©:', error);
          // ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£ÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ localStorage ŸÉŸÄ fallback
          const savedImage = localStorage.getItem(`userAvatar_${user.id}`);
          if (savedImage) {
            setProfileImage(savedImage);
          }
        }
      }
    };

    loadUserAvatar();
  }, [user?.id]);

  // ÿ≠ŸÅÿ∏ ÿßŸÑÿµŸàÿ±ÿ© ŸÅŸä Firestore
  const saveAvatarToFirestore = async (base64String) => {
    if (!user?.id) return;

    try {
      setIsLoading(true);
      
      // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿ¨ŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ (Firestore limit is 1MB per field)
      const sizeInBytes = new Blob([base64String]).size;
      if (sizeInBytes > 900000) { // 900KB ŸÑŸÑÿ£ŸÖÿßŸÜ
        toast.error('ÿ≠ÿ¨ŸÖ ÿßŸÑÿµŸàÿ±ÿ© ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸãÿå Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿµŸàÿ±ÿ© ÿ£ÿµÿ∫ÿ±');
        return false;
      }

      // ÿ≠ŸÅÿ∏ ŸÅŸä Firestore
      await updateDoc(doc(db, 'users', user.id), {
        avatar: base64String,
        avatarUpdatedAt: new Date().toISOString()
      });

      // ÿ≠ŸÅÿ∏ ŸÜÿ≥ÿÆÿ© ŸÖÿ≠ŸÑŸäÿ© ŸÉŸÄ cache
      localStorage.setItem(`userAvatar_${user.id}`, base64String);
      
      return true;
    } catch (error) {
      console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿµŸàÿ±ÿ©:', error);
      toast.error('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿµŸàÿ±ÿ©');
      return false;
    } finally {
      setIsLoading(false);
    }
  };

  // ÿ≠ÿ∞ŸÅ ÿßŸÑÿµŸàÿ±ÿ© ŸÖŸÜ Firestore
  const removeAvatarFromFirestore = async () => {
    if (!user?.id) return;

    try {
      setIsLoading(true);
      
      await updateDoc(doc(db, 'users', user.id), {
        avatar: null,
        avatarUpdatedAt: new Date().toISOString()
      });

      localStorage.removeItem(`userAvatar_${user.id}`);
      return true;
    } catch (error) {
      console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿµŸàÿ±ÿ©:', error);
      toast.error('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿµŸàÿ±ÿ©');
      return false;
    } finally {
      setIsLoading(false);
    }
  };

  const handleLogout = () => {
    logout();
    setShowLogoutConfirm(false);
  };

  // ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏
  const compressImage = (base64String, maxWidth = 300, maxHeight = 300, quality = 0.8) => {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.src = base64String;
      
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;

        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ÿ®ÿπÿßÿØ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÖÿπ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑŸÜÿ≥ÿ®ÿ©
        if (width > height) {
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
        } else {
          if (height > maxHeight) {
            width = (width * maxHeight) / height;
            height = maxHeight;
          }
        }

        canvas.width = width;
        canvas.height = height;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        // ÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ base64 ŸÖÿπ ÿ∂ÿ∫ÿ∑ ÿßŸÑÿ¨ŸàÿØÿ©
        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
        resolve(compressedBase64);
      };

      img.onerror = reject;
    });
  };

  const handleImageUpload = async (event) => {
    const file = event.target.files[0];
    if (file) {
      // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÜŸàÿπ ÿßŸÑŸÖŸÑŸÅ
      if (!file.type.startsWith('image/')) {
        toast.error('Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿµŸàÿ±ÿ© ÿµÿ≠Ÿäÿ≠');
        return;
      }

      // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        toast.error('ÿ≠ÿ¨ŸÖ ÿßŸÑÿµŸàÿ±ÿ© Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ£ŸÇŸÑ ŸÖŸÜ 2 ŸÖŸäÿ¨ÿßÿ®ÿßŸäÿ™');
        return;
      }

      const reader = new FileReader();
      reader.onloadend = async () => {
        try {
          // ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©
          const compressedImage = await compressImage(reader.result);
          
          // ÿ≠ŸÅÿ∏ ŸÅŸä Firestore
          const saved = await saveAvatarToFirestore(compressedImage);
          
          if (saved) {
            setProfileImage(compressedImage);
            toast.success('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿÆÿµŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
            setIsEditingImage(false);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿØÿßŸÑÿ© ŸÖÿ™ÿßÿ≠ÿ©
            if (updateUserProfile) {
              updateUserProfile({ ...user, avatar: compressedImage });
            }
          }
        } catch (error) {
          console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ©:', error);
          toast.error('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ©');
        }
      };
      reader.readAsDataURL(file);
    }
  };

  const handleRemoveImage = async () => {
    const removed = await removeAvatarFromFirestore();
    
    if (removed) {
      setProfileImage(null);
      toast.success('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿÆÿµŸäÿ©');
      setIsEditingImage(false);
      
      // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿØÿßŸÑÿ© ŸÖÿ™ÿßÿ≠ÿ©
      if (updateUserProfile) {
        updateUserProfile({ ...user, avatar: null });
      }
    }
  };

  const getUserRoleLabel = (role) => {
    switch (role) {
      case USER_ROLES.ADMIN:
        return 'ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ';
      case USER_ROLES.SECRETARY:
        return 'ÿ≥ŸÉÿ±ÿ™ÿßÿ±Ÿäÿ©';
      default:
        return 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ';
    }
  };

  const getUserRoleIcon = (role) => {
    switch (role) {
      case USER_ROLES.ADMIN:
        return 'üëë';
      case USER_ROLES.SECRETARY:
        return 'üìù';
      default:
        return 'üë§';
    }
  };

  const getRoleColor = (role) => {
    switch (role) {
      case USER_ROLES.ADMIN:
        return 'bg-purple-100 text-purple-800 border-purple-200';
      case USER_ROLES.SECRETARY:
        return 'bg-blue-100 text-blue-800 border-blue-200';
      default:
        return 'bg-gray-100 text-gray-800 border-gray-200';
    }
  };

  // ŸÖŸÉŸàŸÜ ÿßŸÑÿ£ŸÅÿßÿ™ÿßÿ±
  const Avatar = ({ size = 'small', showEditButton = false }) => {
    const sizeClasses = {
      small: 'w-8 h-8 text-sm',
      medium: 'w-16 h-16 text-xl',
      large: 'w-24 h-24 text-3xl'
    };

    return (
      <div className="relative inline-block">
        {profileImage ? (
          <img
            src={profileImage}
            alt={user?.name}
            className={`${sizeClasses[size]} rounded-full object-cover border-2 border-white shadow-md`}
          />
        ) : (
          <div className={`${sizeClasses[size]} bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold shadow-md`}>
            {user?.name?.charAt(0) || <FiUser />}
          </div>
        )}
        
        {showEditButton && !isLoading && (
          <button
            onClick={() => setIsEditingImage(true)}
            className="absolute bottom-0 right-0 p-1.5 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors shadow-lg"
            title="ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸàÿ±ÿ©"
          >
            <FiCamera size={14} />
          </button>
        )}
        
        {isLoading && (
          <div className="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center">
            <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
          </div>
        )}
      </div>
    );
  };

  return (
    <>
      {/* ÿ≤ÿ± ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä */}
      <div className="relative">
        <button
          onClick={() => setShowProfileModal(true)}
          className="flex items-center gap-2 p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors"
          title="ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä"
        >
          <Avatar size="small" />

          <div className="hidden sm:block text-right text-white">
            <div className="text-sm font-medium">{user?.name}</div>
            <div className="text-xs text-white">{getUserRoleLabel(user?.role)}</div>
          </div>
        </button>
      </div>

      {/* ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä */}
      <Modal
        isOpen={showProfileModal}
        onClose={() => {
          setShowProfileModal(false);
          setIsEditingImage(false);
        }}
        title="ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä"
        size="medium"
      >
        <div className="space-y-6">
          {/* ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© */}
          <div className="text-center">
            <div className="relative inline-block mb-4">
              <Avatar size="large" showEditButton={!isEditingImage} />
            </div>
            
            {/* ÿÆŸäÿßÿ±ÿßÿ™ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ© */}
            {isEditingImage && (
              <div className="mt-4 space-y-3">
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  onChange={handleImageUpload}
                  className="hidden"
                  disabled={isLoading}
                />
                
                <div className="flex gap-2 justify-center">
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    disabled={isLoading}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <FiCamera size={16} />
                    {isLoading ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ±ŸÅÿπ...' : 'ÿßÿÆÿ™Ÿäÿßÿ± ÿµŸàÿ±ÿ©'}
                  </button>
                  
                  {profileImage && (
                    <button
                      onClick={handleRemoveImage}
                      disabled={isLoading}
                      className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <FiTrash2 size={16} />
                      ÿ≠ÿ∞ŸÅ ÿßŸÑÿµŸàÿ±ÿ©
                    </button>
                  )}
                  
                  <button
                    onClick={() => setIsEditingImage(false)}
                    disabled={isLoading}
                    className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    ÿ•ŸÑÿ∫ÿßÿ°
                  </button>
                </div>
                
                <p className="text-xs text-gray-500">
                  ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑÿ≠ÿ¨ŸÖ ÿßŸÑÿµŸàÿ±ÿ©: 2 ŸÖŸäÿ¨ÿßÿ®ÿßŸäÿ™ | ÿßŸÑÿµŸäÿ∫ ÿßŸÑŸÖÿØÿπŸàŸÖÿ©: JPG, PNG, GIF
                  <br />
                  <span className="text-blue-600">ÿ≥Ÿäÿ™ŸÖ ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ£ŸÅÿ∂ŸÑ ÿ£ÿØÿßÿ°</span>
                </p>
              </div>
            )}
            
            <h2 className="text-xl font-semibold text-gray-900 mt-2">{user?.name}</h2>
            <p className="text-gray-600">{user?.email}</p>
          </div>

          {/* ŸÜŸàÿπ ÿßŸÑÿ≠ÿ≥ÿßÿ® */}
          <div className="bg-gray-50 rounded-lg p-4">
            <div className="flex items-center justify-center gap-3">
              <span className="text-2xl">{getUserRoleIcon(user?.role)}</span>
              <div className={`px-4 py-2 rounded-full border ${getRoleColor(user?.role)}`}>
                <span className="font-medium">{getUserRoleLabel(user?.role)}</span>
              </div>
            </div>
          </div>

          {/* ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ® */}
          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span className="text-gray-500">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:</span>
                <div className="font-medium">{user?.username}</div>
              </div>
              <div>
                <span className="text-gray-500">ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:</span>
                <div className="font-medium font-mono text-xs">{user?.id}</div>
              </div>
              <div className="col-span-2">
                <span className="text-gray-500">ŸàŸÇÿ™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ:</span>
                <div className="font-medium">
                  {user?.loginTime ? formatDateTime(user.loginTime) : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
                </div>
              </div>
            </div>
          </div>

          {/* ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ */}
          <div className="flex gap-3 pt-4 border-t border-gray-200">
            <button
              onClick={() => {
                setShowProfileModal(false);
                setIsEditingImage(false);
              }}
              className="flex-1 btn btn-secondary"
            >
              ÿ•ÿ∫ŸÑÿßŸÇ
            </button>
            <button
              onClick={() => {
                setShowProfileModal(false);
                setShowLogoutConfirm(true);
              }}
              className="flex-1 btn btn-error"
            >
              <span className="ml-2">üö™</span>
              ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
            </button>
          </div>
        </div>
      </Modal>

      {/* ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ£ŸÉŸäÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ */}
      <Modal
        isOpen={showLogoutConfirm}
        onClose={() => setShowLogoutConfirm(false)}
        title="ÿ™ÿ£ŸÉŸäÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨"
        size="small"
      >
        <div className="text-center py-4">
          <div className="text-4xl mb-4">üö™</div>
          <h3 className="text-lg font-semibold text-gray-900 mb-2">
            ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü
          </h3>
          <p className="text-gray-600 mb-6">
            ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜŸáÿßÿ° ÿ¨ŸÑÿ≥ÿ© ÿßŸÑÿπŸÖŸÑ ÿßŸÑÿ≠ÿßŸÑŸäÿ© Ÿàÿ≥ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ
          </p>
          
          <div className="flex gap-3">
            <button
              onClick={() => setShowLogoutConfirm(false)}
              className="flex-1 btn btn-secondary"
            >
              ÿ•ŸÑÿ∫ÿßÿ°
            </button>
            <button
              onClick={handleLogout}
              className="flex-1 btn btn-error"
            >
              ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
            </button>
          </div>
        </div>
      </Modal>
    </>
  );
};

export default UserProfile;